{% extends "base.html" %}
{% load i18n has_group %}

{% block pagetitle %}Sessions{% endblock %}

{% block main %}
<div class="row">

  <div class="col-sm-12 col-md-4">
    <div class="card border-0 sticky-top" style="top: 73px; z-index: 0;">
      <div class="card-block">

        {% if user.current_task %}
        <h2 class="text-secondary">Current session</h2>
        <hr class="d-none d-md-block">

        <div class="list-group">
          <div class="list-group-item list-group-item-action">
            <div class="d-flex w-100 justify-content-between">
              <h5 class="mb-1">{{ user.current_task.topic.title }}</h5>
              {% if user.current_task.topic.number %}
              <small>#{{ user.current_task.topic.number }}</small>
              {% endif %}
            </div>
            {% if user.current_task.topic.description %}<p class="mb-1">{{ user.current_task.topic.description }}</p>{% endif %}
            <p class="mb-1">
              <small><strong>Seed query</strong>: {{ user.current_task.topic.seed_query }}</small>
            </p>
            <p class="mb-1">
              <small><strong>Strategy:</strong> {{ user.current_task.get_strategy_display }}</small>
            </p>
            {% if task.task_obj.max_number_of_judgments > 0 %}
            <p class="mb-1">
              <small><strong>Effort (max judgments):</strong> {{ task.task_obj.max_number_of_judgments }}</small>
            </p>
            {% endif %}
            <small>Created {{ user.current_task.created_at }}</small>
          </div>
        </div>
        {% else %}
        <h2 class="text-danger">Please create a session</h2>
        <hr>
        <p>You currently do not have an active session.</p>
        {% endif %}

      </div>
    </div>
  </div>

  {% if tasks %}
  <div class="col-sm-12 col-md-8">
    <div class="card border-0">
      <div class="card-block">
        {% if tasks %}
        <h2 class="text-secondary">Your sessions</h2>
        <hr>
        {% else %}
        <h2 class="text-danger">Please create or select a session</h2>
        <hr>
        <p>There are currently no sessions..</p>
        {% endif %}
        {% for task in tasks %}

        <div class="row mb-4">
          <div class="col-md-9">
            <h5 class="text-truncate">{{ task.task_obj.topic.title }}</h5>
            <p class="mb-1 small text-truncate">
              {% if task.task_obj.topic.description %}
              {{ task.task_obj.topic.description }}
              {% else %}
              Topic description is unavailable.
              {% endif %}
            </p>
            <p class="text-muted m-0" style="font-size: 65%;">Created {{ task.task_obj.created_at }}</p>
          </div>
          <div class="col-md-3 mt-3 mt-md-0 align-self-center center-text">
            <form action="" method="POST">
              {% csrf_token %}
              {% if user.current_task != task.task_obj %}
              <button type="submit" data-session-id="{{ task.task_obj.uuid }}" data-session-title="{{ task.task_obj.topic.title }}" name="activate_sessionid" value="{{ task.task_obj.uuid }}" class="btn btn-sm btn-outline-secondary">Activate</button>
              <a href="#" data-toggle="modal" data-target="#deleteSessionModal" data-session-id="{{ task.task_obj.uuid }}" data-session-title="{{ task.task_obj.topic.title }}" class="btn btn-sm btn-outline-danger delete-modal">Delete</a>
              {% else %}
              <button type="submit" data-session-id="{{ task.task_obj.uuid }}" data-session-title="{{ task.task_obj.topic.title }}" name="activate_sessionid" value="{{ task.task_obj.uuid }}" class="btn btn-sm btn-outline-secondary disabled">Activated</button>
              <a href="#" data-toggle="modal" data-target="#deleteSessionModal" data-session-id="{{ task.task_obj.uuid }}" data-session-title="{{ task.task_obj.topic.title }}" class="btn btn-sm btn-outline-danger delete-modal">Delete</a>{% endif %}
            </form>
          </div>
        </div>
        {% endfor %}
      </div>

      <!-- Delete session modal -->
      <div class="modal fade" id="deleteSessionModal" tabindex="-1" role="dialog" >
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="deleteSessionModalTitle"></h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              Are you sure you want to delete this session?
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-outline-secondary" data-dismiss="modal">Close</button>
              <form action="" method="POST">
                {% csrf_token %}
                <button type="submit" class="btn btn-danger" name="delete_sessionid" value="" id="deleteSessionModalDeleteButton">Delete</button>
              </form>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>
{% endif %}
{% endblock %}

{% block extra_scripts %}
<script>
$(document).on("click", ".delete-modal", function () {
     var session_title = $(this).data('session-title');
     var session_id = $(this).data('session-id');
     console.log(session_title, session_id);
     $("#deleteSessionModalTitle").html( session_title );
     $("#deleteSessionModalDeleteButton").val( session_id );

     return false;
});
</script>
{% endblock %}
